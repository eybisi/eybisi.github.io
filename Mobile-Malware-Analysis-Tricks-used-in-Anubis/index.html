<!DOCTYPE html>
<html lang=tr>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Anubis Anubis is my first case of complicated android malware and taught me so much about android malware. I want to share these learnings in this post. Anubis is almost one year old but its impact is">
<meta name="keywords" content="Malware,Mobile">
<meta property="og:type" content="article">
<meta property="og:title" content="Mobile Malware Analysis : Tricks used in Anubis">
<meta property="og:url" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/index.html">
<meta property="og:site_name" content="eybisi">
<meta property="og:description" content="Anubis Anubis is my first case of complicated android malware and taught me so much about android malware. I want to share these learnings in this post. Anubis is almost one year old but its impact is">
<meta property="og:locale" content="tr">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/anubis.jpg">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/gplay.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/m1.jpg">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/m22.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/downloader.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/flash.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/gunc.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/ope.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/servis.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/sys.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/dropped.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/pikachu.jpg">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/check.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/hata.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/text.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/playprotect.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/overlay.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/webView.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/callforward.png">
<meta property="og:updated_time" content="2019-04-09T22:47:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mobile Malware Analysis : Tricks used in Anubis">
<meta name="twitter:description" content="Anubis Anubis is my first case of complicated android malware and taught me so much about android malware. I want to share these learnings in this post. Anubis is almost one year old but its impact is">
<meta name="twitter:image" content="http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/anubis.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Mobile Malware Analysis : Tricks used in Anubis</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="eybisi" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Ana Sayfa</a></li>
         
          <li><a href="/archives/">Yazılar</a></li>
         
          <li><a href="/Search/">Ara</a></li>
         
          <li><a href="/links/">Yararlı Linkler</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/DEF-CON-Quals-2019-Veryandroidoso/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/STMCTF18-Final-Mobil-Sorulari/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Önceki gönderi</span>
      <span id="i-next" class="info" style="display:none;">Sonraki gönderi</span>
      <span id="i-top" class="info" style="display:none;">Başa dön</span>
      <span id="i-share" class="info" style="display:none;">Gönderiyi paylaş</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&text=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&is_video=false&description=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Mobile Malware Analysis : Tricks used in Anubis&body=Check out this article: http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&name=Mobile Malware Analysis : Tricks used in Anubis&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Anubis"><span class="toc-number">1.</span> <span class="toc-text">Anubis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downloaders"><span class="toc-number">2.</span> <span class="toc-text">Downloaders</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Social-Engineering"><span class="toc-number">3.</span> <span class="toc-text">Social Engineering</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#System-Update"><span class="toc-number">4.</span> <span class="toc-text">System Update ?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence"><span class="toc-number">5.</span> <span class="toc-text">Persistence</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#You-cant-delete-me"><span class="toc-number">6.</span> <span class="toc-text">You cant delete me !</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Accessibility"><span class="toc-number">7.</span> <span class="toc-text">Accessibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keylogger"><span class="toc-number">8.</span> <span class="toc-text">Keylogger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Play-Protect"><span class="toc-number">9.</span> <span class="toc-text">Play Protect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Package-List"><span class="toc-number">10.</span> <span class="toc-text">Package List</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overlay-Attack"><span class="toc-number">11.</span> <span class="toc-text">Overlay Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Process-Scanning"><span class="toc-number">12.</span> <span class="toc-text">Process Scanning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Battery-issues"><span class="toc-number">13.</span> <span class="toc-text">Battery issues</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SMS-Interception-and-Call-forwarding"><span class="toc-number">14.</span> <span class="toc-text">SMS Interception and Call forwarding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">15.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">16.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Readings"><span class="toc-number">17.</span> <span class="toc-text">Readings</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Mobile Malware Analysis : Tricks used in Anubis
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">eybisi</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-04-07T13:41:35.000Z" itemprop="datePublished">2019-04-07</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Malware/">Malware</a>, <a class="tag-link" href="/tags/Mobile/">Mobile</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Anubis"><a href="#Anubis" class="headerlink" title="Anubis"></a>Anubis</h2><p><img src="anubis.jpg" width="250"></p>
<p>Anubis is my first case of <code>complicated</code> android malware and taught me so much about android malware. I want to share these learnings in this post. Anubis is almost one year old but its impact is much higher than older banker families and campaign is <a href="https://twitter.com/0xabc0/status/1113698644442656773" target="_blank" rel="noopener">still going on</a>. Small section of anubis downloader samples found in play store in between July 2018 and March 2019 :</p>
<p><img src="gplay.png" alt=""></p>
<p>Anubis is full of tricks. List of capabilities: </p>
<ul>
<li>Steal information with overlay attacks from banking apps</li>
<li>Ransomware</li>
<li>SMS interception / Call forwarding</li>
<li>RAT</li>
<li>Keylogger</li>
</ul>
<p>To spread malware generally google play store is used.   </p>
<h2 id="Downloaders"><a href="#Downloaders" class="headerlink" title="Downloaders"></a>Downloaders</h2><p>Anubis generally consist of two part. I’ll call them downloader and payload. If malware spreads over third party sites, such as <code>flash updates</code> it only downloads payload of anubis. But if malware spreads over google play store, it uses downloader. Because it needs to. If payload of anubis is used it will be detected by play protect easily. So to download payload, fake applications deployed on play store. But how an application downloads and installs another application ?<br>Easy, with <code>REQUEST_INSTALL_PACKAGES</code> permission. I think in the current state of Play Store this permission is dangerous than any other one. Because Play Protect can catch malware and rats if published on play store. Spread of malware generally comes from this permission. Users need to check if this permission is in permission list.</p>
<h2 id="Social-Engineering"><a href="#Social-Engineering" class="headerlink" title="Social Engineering"></a>Social Engineering</h2><p>Malware needs to lower suspicion of user after installation. Anubis downloaders use little but strong steps to make user believe it is legitimate app. Since threat actors want to catch valuable victims, generally these fake applications will be finance related apps. Such as <code>Currency Converter</code>. </p>
<table>
<thead>
<tr>
<th style="text-align:center">Curreny - Gold - Euro</th>
<th style="text-align:center">Currency Center </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="m1.jpg" alt=""></td>
<td style="text-align:center"><img src="m22.png" alt=""></td>
</tr>
</tbody>
</table>
<p>( notice #1 trending )</p>
<p>But these apps will imitate legitimate ones. Here is how earlier fake apps worked. After installing, app will remove itself from homescreen. Why ? Lets say you downloaded an app. But it didn’t worked like you wanted. What you do ? Go back to homescreen and delete that app right ? Now you need to go to settings. Also after opening fake app, generally app will prompt <code>App needs to be updated</code> and forward user to legitimate app that have same app icon, app name and almost same developer name. So you downloaded an app, it forwarded to real one and you installed it. When you go back to your homescreen, you will see only one app which is legitimate one. With this, suspicion of user is lowered. But when you go to settings and list application, you will see 2 of them.</p>
<p><img src="downloader.gif" width="350" height="200"></p>
<p>Also ! if you try to remove malware from settings an system error(!) will show up.</p>
<h2 id="System-Update"><a href="#System-Update" class="headerlink" title="System Update ?"></a>System Update ?</h2><p>After user installs downloader, app will download second stage of attack, payload. Generally name of downloaded apk will be either <code>Sistem Guncellemesi, Operator Guncellemesi, Flash Update, Yazilim Guncellemesi</code>. Names are in Turkish, meaning System Update, Operator Update, Software Update. Icons of these apps:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Flash Player Update</th>
<th style="text-align:center">Update</th>
<th style="text-align:center">Operator Update</th>
<th style="text-align:center">Service Update</th>
<th style="text-align:center">System Update</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><img src="flash.png" alt=""></td>
<td style="text-align:center"><img src="gunc.png" alt=""></td>
<td style="text-align:center"><img src="ope.png" alt=""></td>
<td style="text-align:center"><img src="servis.png" alt=""></td>
<td style="text-align:center"><img src="sys.png" alt=""></td>
</tr>
</tbody>
</table>
<p>With these icons threat actors want user to believe these are legitimate apps. After downloader gets payload app from command and control server, prompt will shown to user. User needs to activate <code>third-party installation</code> and press yes to prompt screen. Then app will installed. After user opens up, app will ask for permissions then nothing will shown and app will dissepear from app list.</p>
<p><img src="dropped.gif" width="350" height="200"></p>
<p>Did you see flickering after giving Accessibility permission ? We will come to that.</p>
<h2 id="Persistence"><a href="#Persistence" class="headerlink" title="Persistence"></a>Persistence</h2><p>In desktop malware generally malware will write itself to <code>Startup</code> folder to get persistence and open itself each boot. What about Android malware ? Let me introduce you to <code>RECEIVE_BOOT_COMPLETED</code>. With this receiver, app can open itself in background when device is booted. Cool right ?</p>
<h2 id="You-cant-delete-me"><a href="#You-cant-delete-me" class="headerlink" title="You cant delete me !"></a>You cant delete me !</h2><p>Lets say user gave all permission to application and installed it. But you want to remove app. When you go to settings and try to delete app, you click the app icon. It says <code>System apps cannot be deleted</code> and you are forwarded to user to Home Screen.<br>What ?</p>
<p><img src="pikachu.jpg" width="250" height="250"></p>
<p>App didn’t take device admin permissions. How it can do that ? Lets find out.</p>
<h2 id="Accessibility"><a href="#Accessibility" class="headerlink" title="Accessibility"></a>Accessibility</h2><p>From <a href="https://developer.android.com/reference/android/view/accessibility/AccessibilityEvent" target="_blank" rel="noopener">official android page</a> :’Accessibility Services run in the background and receive callbacks by the system when AccessibilityEvents are fired. Such events denote some state transition in the user interface, for example, the <strong>focus has changed</strong>, a <strong>button has been clicked</strong>, etc. Such a service can optionally <strong>request</strong> the capability for querying the content of the <strong>active window</strong>‘.</p>
<p>What can go wrong right ?</p>
<p>It can track user activities and have ability to <strong>query</strong> certain things such as message boxes. Each accessibility event have source component that defines which application triggered current event. There are different event types anubis use : </p>
<ul>
<li>TYPE_VIEW_CLICKED</li>
<li>TYPE_VIEW_FOCUSED</li>
<li>TYPE_VIEW_TEXT_CHANGED</li>
<li>TYPE_WINDOW_STATE_CHANGED</li>
</ul>
<p>To see what all Accessibility Event types are take a look at :  <a href="https://developer.android.com/reference/android/view/accessibility/AccessibilityEvent" target="_blank" rel="noopener">AccessibilityEvent</a></p>
<p>Anubis tracks all accessibility events and checks event types. So if you open new app window state will change and event will trigger. Event type of <code>TYPE_WINDOW_STATE_CHANGED</code> is first check. To remove malware you probably go to Settings. Settings is also an android application called <code>com.android.settings</code>. Second check is if triggered event comes from <code>com.android.settings</code>. Then malware checks if certain strings in Event description.</p>
<p><img src="check.png" alt="check"></p>
<p> First check is for name of the app you clicked :</p>
<ul>
<li>Servis Guncellemesi (this.a.i(this))</li>
</ul>
<p>Then below strings:</p>
<ul>
<li>uninstall (this.f)</li>
<li>to remove (this.g)</li>
</ul>
<p>If all conditions hold, an Activity is triggered <code>a()</code> . This activity just opens AlertDialog which says <code>System apps cannot be deleted</code>. Since Application doesnt have any Launchable content, android opens alert box in the Homescreen. So whenever you try to open Malware’s details in Settings you forwarded to homescreen with alert box and you can’t delete app.</p>
<p><img src="hata.gif" width="350" height="200"></p>
<p>Maybe if I remove Accessibility permission from app, I should able to remove it right ? No. Lets say you removed permission. All’s fine. But when you open Settings again, malware will constantly ask you to give permission. You cant navigate to Apps section of Settings to remove app. Fine, maybe If I reboot then I can remove app ? Remember <code>RECEIVE_BOOT_COMPLETED</code> permission ? App will start again and ask for Accessibility permission. But you have other ways to remove the app. If you have application manager apps with package name other than <code>com.android.settings</code> you can delete malware. Or by booting in safe mode. Also if you have adb enabled and you know packagename you can delete it with : <code>adb uninstall packagename</code>. To learn package names you can list all packages with <code>adb shell pm list packages</code></p>
<h2 id="Keylogger"><a href="#Keylogger" class="headerlink" title="Keylogger"></a>Keylogger</h2><p>Now we covered <code>TYPE_WINDOW_STATE_CHANGED</code> event. Lets look at other 3 event.</p>
<ul>
<li>TYPE_VIEW_CLICKED</li>
<li>TYPE_VIEW_FOCUSED</li>
<li>TYPE_VIEW_TEXT_CHANGED </li>
</ul>
<p>EVERY input box you click/focus and write text into it, will trigger one the three event. No matter what app you are in. So lets say TYPE_VIEW_TEXT_CHANGED event triggered and malware caught it. With just <code>obj = accessibilityEvent.getText().toString();</code> it can get changed text and send back to its command and control server. Event type 16 = <code>TYPE_VIEW_TEXT_CHANGED</code><br><img src="text.png" alt="text"></p>
<p>Remember flickering after giving the accessibility permission to malware ? With accessibility, app can press buttons (yes literally). Malware press <code>yes</code> without user interaction.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( node : source.findAccessibilityNodeInfosByText(<span class="keyword">this</span>.e)) &#123;</span><br><span class="line">                node.performAction(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You guessed right, action 16 is <code>ACTION_CLICK</code> and this.e holds <code>StringYes</code>.</p>
<h2 id="Play-Protect"><a href="#Play-Protect" class="headerlink" title="Play Protect"></a>Play Protect</h2><p>Even though malware installed on the device from downloader without being flagged, Play Protect will constantly scan the device if its enabled and will flag anubis app as a malware. To overcome this malware tries to disable Play protect. </p>
<p><img src="playprotect.png" alt=""></p>
<h2 id="Package-List"><a href="#Package-List" class="headerlink" title="Package List"></a>Package List</h2><p>When malware installed, first thing it does is listing installed packages and sending it to command and control server. These application names are sometimes used for another purpose. For example when threat actor knows you have, lets say ‘com.x.bank’ app, threat actor sends sms that crafted for that app to lure user to open <code>com.x.bank</code> application. <code>You have received 10.000$. Login in to your X account</code> With this technique user will open that app and fake overlay will shown. This can be taught as backup plan for phishing user.</p>
<p>How can android app list installed packages ? Easy <code>getInstalledApplications</code><br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">pman = context.getPackageManager()</span><br><span class="line"><span class="keyword">for</span> ( ApplicationInfo appInf : pman.getInstalledApplications(<span class="number">128</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(appInf.packageName.equals(<span class="string">"com.x.bank"</span>))&#123;</span><br><span class="line">        arrayList.add(<span class="string">"com.x.bank"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Overlay-Attack"><a href="#Overlay-Attack" class="headerlink" title="Overlay Attack"></a>Overlay Attack</h2><p>Malware authors always try to find creative ways to fool victims to get their information. Overlay attack is one of them. Since early 2016 (<a href="https://lukasstefanko.com/2016/02/android-mazarbot-stealing-credit-card-information-in-italy-with-certified-issued-by-putin.html" target="_blank" rel="noopener">MazarBot</a> ) a lot of android malware used this technique for collecting user information. When targeted apps opened, malware triggers and pulls phishing page that generated for that targeted app from command and control server and <code>overlays</code> over targeted app. Showing it is easier.</p>
<p><img src="overlay.gif" width="350" height="200"></p>
<p>(random banking app is chosen. There are 100+ targeted apps)</p>
<p>Since overlayed screen is similar to original app and process of overlaying is done in very short time, user probably dont get suspicious. But how malware detects opened apps and overlays itself on top of another process ? Lets find out !</p>
<h2 id="Process-Scanning"><a href="#Process-Scanning" class="headerlink" title="Process Scanning"></a>Process Scanning</h2><p>Getting package list is not enough for overlay attack. Malware needs to know that user just opened “com.x.bank” app to make believable overlay scenerio. Or user wont fall it and be suspicious about it. There is no “an app opened” service in android. The way malware does is simple: somehow get running process list and get top process. Put that function in <code>While(true){ }</code> loop. This way you will know when new app opened. The ways of getting process list differs in targeted SDK versions. Anubis need permission to get process list if API version is greater than 23. It uses  <code>PACKAGE_USAGE_STATS</code> permission to use UsageStatsManager and get list of running processes. If API version is &lt; 23 then there are functions to get list of processes without any permission. I’ll focus on this topic on my next post. After getting process/package names, malware compare these with banking apps package names. Then opens up corresponding phishing page through webView. This action doesn’t need any permission. Any app can open itself without user interaction ! (Not in Android 9 YAY !)</p>
<p><img src="webView.png" height="200"></p>
<p>Then collected data will be send to command and control server. </p>
<h2 id="Battery-issues"><a href="#Battery-issues" class="headerlink" title="Battery issues"></a>Battery issues</h2><p>But running in forever loop will cause some battery issues right? Battery optimizing apps will close malware. Malware author was aware of this and here comes another permission <code>REQUEST_IGNORE_BATTERY_OPTIMIZATIONS</code>. With this permission app will not seen in battery optimizations.  </p>
<h2 id="SMS-Interception-and-Call-forwarding"><a href="#SMS-Interception-and-Call-forwarding" class="headerlink" title="SMS Interception and Call forwarding"></a>SMS Interception and Call forwarding</h2><p>This is scary part. Malware already have SMS_READ permission for reading sms. Why ? For OTP codes. Addition to reading, malware requests for being default SMS app. If user accepts, threat actor behind the command and control server can delete SMS from device. Then sms will be removed and user wont have any clue.</p>
<p>Call forwarding, oh this is really scary. Lets say bank understood user is victim of malware. Calls him/her number. But who opens the phone ? threat actor.</p>
<p><img src="callforward.png" alt="callforward"></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Two permission for two stages of anubis. <code>REQUEST_INSTALL_PACKAGES</code> and <code>PACKAGE_USAGE_STATS</code> these are releated to core components of the malware to fool user. I hope you learned something new about android malware. If you have any question feel free to ask me <a href="https://twitter.com/0xabc0" target="_blank" rel="noopener">@0xabc0</a></p>
<p>While writing this post, Android announced 9 beta with great security related news ! Now apps can’t open itself without user interaction, no more overlay tactics for malware !</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://forum.yugiohcardmaker.net/user/731508-gregory-the-gregory/" target="_blank" rel="noopener">Anubis Image gregory-the-gregory</a></p>
<h2 id="Readings"><a href="#Readings" class="headerlink" title="Readings"></a>Readings</h2><p>Anubis Related:<br><a href="https://koodous.com/apks?search=tag:anubis" target="_blank" rel="noopener">Koodous for finding anubis sample</a><br><a href="https://twitter.com/LukasStefanko/status/1084728042927341569" target="_blank" rel="noopener">LukasStefanko’s twitter thread</a><br><a href="https://blog.trendmicro.com/trendlabs-security-intelligence/google-play-apps-drop-anubis-banking-malware-use-motion-based-evasion-tactics/" target="_blank" rel="noopener">Trend Micro’s post about Anubis</a><br><a href="https://securityintelligence.com/anubis-strikes-again-mobile-malware-continues-to-plague-users-in-official-app-stores/" target="_blank" rel="noopener">IBM X-Force’s post about Anubis</a><br><a href="https://news.sophos.com/en-us/2018/08/14/anubis-is-back-are-you-prepared/" target="_blank" rel="noopener">Sophos Labs’ post about Anubis</a></p>
<p>If you want to read related posts about android malware heres my other posts:<br><a href="https://pentest.blog/n-ways-to-unpack-mobile-malware/" target="_blank" rel="noopener">How to defeat packers in Android ecosystem</a><br><a href="https://eybisi.run/2018/07/31/Mobil-Zararli-Analizi-Bolum-1-Ortami-Kuralim/">How to setup android malware analysis lab (in Turkish)</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Yorumları görebilmek için lütfen JavaScripte izin verin.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Ana Sayfa</a></li>
         
          <li><a href="/archives/">Yazılar</a></li>
         
          <li><a href="/Search/">Ara</a></li>
         
          <li><a href="/links/">Yararlı Linkler</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Anubis"><span class="toc-number">1.</span> <span class="toc-text">Anubis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Downloaders"><span class="toc-number">2.</span> <span class="toc-text">Downloaders</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Social-Engineering"><span class="toc-number">3.</span> <span class="toc-text">Social Engineering</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#System-Update"><span class="toc-number">4.</span> <span class="toc-text">System Update ?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence"><span class="toc-number">5.</span> <span class="toc-text">Persistence</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#You-cant-delete-me"><span class="toc-number">6.</span> <span class="toc-text">You cant delete me !</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Accessibility"><span class="toc-number">7.</span> <span class="toc-text">Accessibility</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keylogger"><span class="toc-number">8.</span> <span class="toc-text">Keylogger</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Play-Protect"><span class="toc-number">9.</span> <span class="toc-text">Play Protect</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Package-List"><span class="toc-number">10.</span> <span class="toc-text">Package List</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overlay-Attack"><span class="toc-number">11.</span> <span class="toc-text">Overlay Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Process-Scanning"><span class="toc-number">12.</span> <span class="toc-text">Process Scanning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Battery-issues"><span class="toc-number">13.</span> <span class="toc-text">Battery issues</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SMS-Interception-and-Call-forwarding"><span class="toc-number">14.</span> <span class="toc-text">SMS Interception and Call forwarding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">15.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">16.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Readings"><span class="toc-number">17.</span> <span class="toc-text">Readings</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&text=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&is_video=false&description=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Mobile Malware Analysis : Tricks used in Anubis&body=Check out this article: http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&title=Mobile Malware Analysis : Tricks used in Anubis"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/&name=Mobile Malware Analysis : Tricks used in Anubis&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menü</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> İçindekiler</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Paylaş</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Başa dön</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    in locexum we trust &copy; 2020 eybisi
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Ana Sayfa</a></li>
         
          <li><a href="/archives/">Yazılar</a></li>
         
          <li><a href="/Search/">Ara</a></li>
         
          <li><a href="/links/">Yararlı Linkler</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-129796595-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'eybisi-run';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


