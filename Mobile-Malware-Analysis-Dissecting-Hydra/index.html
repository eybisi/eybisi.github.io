<!DOCTYPE html>
<html lang=tr>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Hydra Hydra is another bankbot variant. It uses overlay to steal information like Anubis. It’s name comes from command and control panel. Through July 2018 to March 2019 there was 8-10 sample on Googl">
<meta name="keywords" content="Malware,Mobile">
<meta property="og:type" content="article">
<meta property="og:title" content="Mobile Malware Analysis : Dissecting Hydra">
<meta property="og:url" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/index.html">
<meta property="og:site_name" content="Ahmet Bilal Can">
<meta property="og:description" content="Hydra Hydra is another bankbot variant. It uses overlay to steal information like Anubis. It’s name comes from command and control panel. Through July 2018 to March 2019 there was 8-10 sample on Googl">
<meta property="og:locale" content="tr">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/hydra.jpg">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/gdb.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/break.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/hydra1.jpg.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/hydra_time.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/xor.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/while.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/xor_block.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/xor_b2.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/sim.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/second.png">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/dropdex.gif">
<meta property="og:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/init.png">
<meta property="og:updated_time" content="2019-07-09T13:12:46.390Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mobile Malware Analysis : Dissecting Hydra">
<meta name="twitter:description" content="Hydra Hydra is another bankbot variant. It uses overlay to steal information like Anubis. It’s name comes from command and control panel. Through July 2018 to March 2019 there was 8-10 sample on Googl">
<meta name="twitter:image" content="http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/hydra.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Mobile Malware Analysis : Dissecting Hydra</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/atom.xml" title="Ahmet Bilal Can" type="application/atom+xml" />
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Ana Sayfa</a></li>
         
          <li><a href="/about/">Hakkımda</a></li>
         
          <li><a href="/archives/">Yazılar</a></li>
         
          <li><a href="/Search/">Ara</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/Mobile-Malware-Analysis-Overlay-and-How-to-Counter-it/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Önceki gönderi</span>
      <span id="i-next" class="info" style="display:none;">Sonraki gönderi</span>
      <span id="i-top" class="info" style="display:none;">Başa dön</span>
      <span id="i-share" class="info" style="display:none;">Gönderiyi paylaş</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&text=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&is_video=false&description=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Mobile Malware Analysis : Dissecting Hydra&body=Check out this article: http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&name=Mobile Malware Analysis : Dissecting Hydra&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hydra"><span class="toc-number">1.</span> <span class="toc-text">Hydra</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Time-Check"><span class="toc-number">2.</span> <span class="toc-text">Time Check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GDB-Debug"><span class="toc-number">3.</span> <span class="toc-text">GDB Debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ghidra-Shenanigans"><span class="toc-number">4.</span> <span class="toc-text">Ghidra Shenanigans</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Drop-Dex"><span class="toc-number">5.</span> <span class="toc-text">Drop Dex</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Mobile Malware Analysis : Dissecting Hydra
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Ahmet Bilal Can</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-06-14T12:44:53.000Z" itemprop="datePublished">2019-06-14</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Malware/">Malware</a>, <a class="tag-link" href="/tags/Mobile/">Mobile</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Hydra"><a href="#Hydra" class="headerlink" title="Hydra"></a>Hydra</h2><p><img src="hydra.jpg" width="250"></p>
<p>Hydra is another bankbot variant. It uses overlay to steal information like <a href="https://eybisi.run/Mobile-Malware-Analysis-Tricks-used-in-Anubis/">Anubis</a>. It’s name comes from <a href="https://twitter.com/PRODAFT/status/1096458491852664840" target="_blank" rel="noopener">command and control panel</a>. Through July 2018 to March 2019 there was 8-10 sample on Google Play Store. Distrubition of malware is similar to Anubis cases. Downloader apps are uploaded to Play Store. But unlike Anubis, Downloader apps extract code from png files with <kinda> steganography and downloads malicious app from command and control server. You can find samples that I will go through in this post here :</kinda></p>
<ul>
<li><a href="https://koodous.com/apks/46aeb04f2f03ebe7c716fc6e58a5dea763cd9b00eb7a466d10a0744f50a7368f/comments" target="_blank" rel="noopener">Downloader</a></li>
<li><a href="https://koodous.com/apks/fd11256379366a6f08945064a9d2b88f8fb5bdfb16be997dad4f26689715b519" target="_blank" rel="noopener">Malware</a></li>
</ul>
<p>Table of contents:</p>
<ul>
<li>Time check</li>
<li>GDB Debug</li>
<li>Ghidra shenanigans</li>
<li>Drop dex file</li>
<li>Dropped APK</li>
</ul>
<p>First of all if I run apk on my emulator it doesnt drop dex file. </p>
<h2 id="Time-Check"><a href="#Time-Check" class="headerlink" title="Time Check"></a>Time Check</h2><p>When we open first app with <code>jadx</code> we can see time check in class <code>com.taxationtex.giristexation.qes.Hdvhepuwy</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">j</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date().getTime() &gt;= <span class="number">1553655180000L</span> &amp;&amp; <span class="keyword">new</span> Date().getTime() &lt;= <span class="number">1554519180000L</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This function called in another class : <code>com.taxationtex.giristexation.qes.Sctdsqres</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sctdsqres</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> L = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span>  <span class="keyword">void</span> <span class="title">fyndmmn</span><span class="params">(Object obj)</span></span>;</span><br><span class="line">    Sctdsqres() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">j</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Hdvhepuwy.j()) &#123;</span><br><span class="line">            H();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">H</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!L) &#123;</span><br><span class="line">            System.loadLibrary(<span class="string">"hoter"</span>);</span><br><span class="line">            L = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fyndmmn(Hdvhepuwy.j());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>First it checks time and if condition holds, app will load native library and calls <code>fyndmmn(Hdvhepuwy.j());</code> which is native function. We need to bypass this check and app will always load library. </p>
<p>I used apktool to disassemble apk to smali and changed <code>j()</code> to always return true. </p>
<ul>
<li><code>apktool d com.taxationtex.giristexation.apk</code></li>
<li><code>cd com.taxationtex.giristexation/smali/com/taxationtex/giristexation/qes</code></li>
<li><code>edit j()Z in Hdvhepuwy.smali</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.method public <span class="keyword">static</span> j()Z</span><br><span class="line">    .locals <span class="number">1</span></span><br><span class="line">    <span class="keyword">const</span>/<span class="number">4</span> v0, <span class="number">0x1</span></span><br><span class="line">    <span class="keyword">return</span> v0</span><br><span class="line">.end method</span><br></pre></td></tr></table></figure>
<p>rebuild apk with <code>apktool b com.taxationtex.giristexation -o hydra_time.apk</code> and sign it.</p>
<p>Now time control will always return true and after loading native library, <code>fyndmmn</code> native function is called. Even with this still app doesn’t load dex file.</p>
<h2 id="GDB-Debug"><a href="#GDB-Debug" class="headerlink" title="GDB Debug"></a>GDB Debug</h2><p><a href="https://packmad.github.io/gdb-android/" target="_blank" rel="noopener">Here</a> is great post explaining how to setup gdb to debug native libraries. Steps:</p>
<ul>
<li>Download android sdk with <a href="https://dl.google.com/android/repository/android-ndk-r20-linux-x86_64.zip" target="_blank" rel="noopener">ndk</a></li>
<li>adb push ~/android-sdk-linux/ndk-bundle/prebuilt/android-arm/gdbserver/gdbserver /data/local/tmp`</li>
<li>adb shell “chmod 777 /data/local/tmp/gdbserver”</li>
<li>adb shell “ls -l /data/local/tmp/gdbserver”</li>
<li>get process id, ps -A | grep com.tax</li>
<li>/data/local/tmp/gdbserver :1337 –attach $pid</li>
<li>adb forward tcp:1337 tcp:1337</li>
<li>open up gdb </li>
<li>target remote :1337</li>
<li>b Java_com_tax\TAB</li>
</ul>
<p>There is small problem here. App will load library and call native function and exit. App needs to wait for gdb connection. My first thought was putting sleep function and then connect with gdb. </p>
<ul>
<li>apktool d hydra_time.apk</li>
<li>nvim hydra_time/com.taxationtex.giristexation/smali/com/taxationtex/giristexation/qes/Sctdsqres.smali</li>
</ul>
<p>Add<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>-wide/<span class="number">32</span> v0, <span class="number">0xea60</span></span><br><span class="line">invoke-<span class="keyword">static</span> &#123;v0, v1&#125;, Landroid/os/SystemClock;-&gt;sleep(J)V</span><br></pre></td></tr></table></figure></p>
<p>after following block:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.line <span class="number">43</span></span><br><span class="line">:cond_0</span><br></pre></td></tr></table></figure></p>
<p>and since locals is 1 and we use extra v1 variable, increment it to 2<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.<span class="function">method <span class="keyword">static</span> <span class="title">H</span><span class="params">()</span>V</span></span><br><span class="line"><span class="function">    .locals 2</span></span><br></pre></td></tr></table></figure></p>
<p>Again sign and install the app. If all goes well app will wait 60 seconds in whitescreen. Now we can connect with gdb.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps | grep com.tax</span><br><span class="line">/data/<span class="built_in">local</span>/tmp/gdbserver :1337 --attach <span class="variable">$pid</span></span><br></pre></td></tr></table></figure>
<p>I use pwndbg for better gdb experience, you can try peda or whatever you want.</p>
<ul>
<li>adb forward tcp:1337 tcp:1337</li>
<li>gdb</li>
<li>target remote :1337 </li>
</ul>
<p><img src="gdb.gif" alt=""></p>
<p>It takes time to load all libraries from remote. Then put breakpoint to native function</p>
<p><img src="break.gif" alt=""></p>
<p>Since genymotion is x86 i will use lib/x86/libhoter.so file. We will use ghidra to see decompiled codes.</p>
<p>First of all if you want to sync gdb and ghidra addresses,</p>
<p>Type vmmap at gdb and look for first entry of <code>libhoter.so</code>. </p>
<p><code>0xe73be000 0xe73fc000 r-xp    3e000 0      /data/app/com.taxationtex.giristexation-1/lib/x86/libhoter.so</code></p>
<p>So <code>0xe73be000</code> is my base address.</p>
<p>Go to <code>Window</code> -&gt; <code>Memory Map</code> and press <code>Home</code> icon on upper right. Put your base address and rebase binary.</p>
<p> Lets look at entry of native function</p>
<p><img src="hydra1.jpg.png" alt=""></p>
<p>Why call time ? Again time check ? Rename return value of time function (curr_time) and press <code>ctrl+shift+f</code> from assembly view and go to location that context is <code>READ</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (uint)(curr_time + <span class="number">0xa3651a74</span>U &lt; <span class="number">0xd2f00</span>)</span><br></pre></td></tr></table></figure>
<p>So we were right, time check.. Lets calculate</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="number">0xffffffff</span><span class="number">-0xa3651a74</span>+<span class="number">0xd2f00</span></span><br><span class="line">&gt;&gt;&gt; <span class="number">1554519179</span></span><br><span class="line">&gt;&gt;&gt; (<span class="number">1554519179</span>+ <span class="number">0xa3651a74</span>) &amp; <span class="number">0xffffffff</span> &lt; <span class="number">0xd2f00</span></span><br><span class="line">&gt;&gt;&gt; True</span><br></pre></td></tr></table></figure>
<p>convert epoch to time : Saturday, April 6, 2019 2:52:59 AM</p>
<p>Lets check how this boolean is used. Look for xrefs of check_time function.</p>
<p><img src="hydra_time.png" alt=""></p>
<p>Yep, as we think it will exit if time doesn’t hold.</p>
<p>First breakpoint/binary patch point is here. Or we can change emulator/phone’s time to April 5 2019.</p>
<p><code>b *(base + 0x8ba8)</code></p>
<p>Bypassing time check is not enough.</p>
<h2 id="Ghidra-Shenanigans"><a href="#Ghidra-Shenanigans" class="headerlink" title="Ghidra Shenanigans"></a>Ghidra Shenanigans</h2><p>Now diving into binary file you will find functions like this :</p>
<p><img src="xor.png" alt=""></p>
<p>If you look at while loop.</p>
<p><img src="while.png" alt=""></p>
<p>2 blocks of data are xored with the length <code>0x18</code>. We can put breakpoint after do while but it will not be efficent solution. Lets think a programmatic way to find decrypted strings.</p>
<p>These xor blocks are next to each other. If we can find get length of blocks we can easily get decrypted string. Find function that use these xor blocks and rename it. Then we can jump 2*length and get next xor blocks. </p>
<p>Starting xor block is 0x34035. </p>
<p>Get xrefs of block, </p>
<p><img src="xor_block.png" alt=""></p>
<p>go to function,</p>
<p><img src="xor_b2.png" alt=""></p>
<p>get size from CMP instruction, since we know first xor block add size to address of xor block and get second xor block. Decrypt it and rename the function.</p>
<p>Ghidra : go to <code>Window</code> -&gt; <code>Script Manager</code> -&gt; <code>Create New Script</code> -&gt; <code>Python</code>.</p>
<p>Set name for script and lets write our ghidra script.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ghidra.app.script.GhidraScript</span><br><span class="line"><span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> ghidra.program.model.address <span class="keyword">import</span> AddressOutOfBoundsException</span><br><span class="line"><span class="keyword">from</span> ghidra.program.model.symbol <span class="keyword">import</span> SourceType</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor_block</span><span class="params">(addr,size)</span>:</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">## get byte list</span></span><br><span class="line">	first_block = getBytes(toAddr(addr),size).tolist()</span><br><span class="line">	second_block = getBytes(toAddr(addr+size),size).tolist()</span><br><span class="line"></span><br><span class="line">	a = <span class="string">""</span></span><br><span class="line">	<span class="comment">## decrypt the block</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(len(first_block)):</span><br><span class="line">		a += chr(first_block[i]^second_block[i])</span><br><span class="line">	trash = len(<span class="string">"someval"</span>)</span><br><span class="line">	<span class="keyword">return</span> a[:-trash]</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">block</span><span class="params">(addr)</span>:</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> addr == <span class="number">0x34755</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0x0003494f</span></span><br><span class="line">	<span class="comment">## get xrefs</span></span><br><span class="line">	xrefs = getReferencesTo(toAddr(addr))</span><br><span class="line">	<span class="keyword">if</span> len(xrefs) ==<span class="number">0</span>:</span><br><span class="line">		<span class="comment">## no xrefs go to next byte</span></span><br><span class="line">		<span class="keyword">return</span> addr+<span class="number">1</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span> xref <span class="keyword">in</span> xrefs:</span><br><span class="line">		ref_addr = xref.getFromAddress()</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			inst = getInstructionAt(ref_addr.add(<span class="number">32</span>))</span><br><span class="line">		<span class="keyword">except</span> AddressOutOfBoundsException <span class="keyword">as</span> e:</span><br><span class="line">			print(<span class="string">"Found last xor block exiting.."</span>)</span><br><span class="line">			exit()</span><br><span class="line">            </span><br><span class="line">        <span class="comment">## Get size of block with inst.getByte(2)</span></span><br><span class="line">		block_size = inst.getByte(<span class="number">2</span>)</span><br><span class="line">        <span class="comment">## decrypt blocks</span></span><br><span class="line">		dec_str = xor_block(addr,block_size)</span><br><span class="line">        <span class="comment">## get function</span></span><br><span class="line">		func = getFunctionBefore(ref_addr)</span><br><span class="line">		new_name = <span class="string">"dec_"</span>+dec_str[:<span class="number">-1</span>]</span><br><span class="line">        <span class="comment">## rename the function</span></span><br><span class="line">		func.setName(new_name,SourceType.USER_DEFINED)</span><br><span class="line">        <span class="comment">## log</span></span><br><span class="line">		print(<span class="string">"Block : &#123;&#125; , func : &#123;&#125;, dec string : &#123;&#125;"</span>.format(hex(addr),func.getEntryPoint(),dec_str))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> addr+<span class="number">2</span>*block_size</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_encrypted_str</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">## starting block</span></span><br><span class="line">	curr_block_location = <span class="number">0x00034035</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">		curr_block_location = block(curr_block_location)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">	extract_encrypted_str()</span><br><span class="line"></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>
<p>If you want to run script, select created script in <code>Script Manager</code> and press Run.</p>
<p>Now lets look at the output.</p>
<p><img src="sim.png" alt=""></p>
<p>As you can see there are functions : <code>getSimCountryISO</code>, <code>getNetworkCountryIso</code>, <code>getCountry</code> and one suspicious string : <code>tr</code>. Without running we can assume code will check if these functions return values are equals to <code>tr</code>. I know this app targets Turkish people so this is reasonable to avoid sandbox and even manual analyze. </p>
<p>If you follow from these functions’ xrefs to function <code>FUN_00018A90()</code> (called after time check) you can see this block : </p>
<p><img src="second.png" alt=""></p>
<p>So next patch/breakpoint is this check :</p>
<p><code>b *(base + 0x8c80)</code></p>
<p>After these checks code will drop dex and load it. If you run without patch/breakpoints only <code>edevlet</code> page is shown and nothing happens. Lets try with bypassing checks :</p>
<p>first breakpont : </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b *(base + 0x8ba8)</span><br><span class="line">copy address .... a8 -&gt; <span class="built_in">set</span> <span class="variable">$eip</span>= .... aa</span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b *(base + 0x8c80)</span><br><span class="line">copy address .... 80 -&gt; <span class="built_in">set</span> <span class="variable">$eip</span> = .... 82</span><br><span class="line">c</span><br></pre></td></tr></table></figure>
<p><img src="dropdex.gif" alt=""></p>
<p>Or we can patch <code>je</code> instructions to <code>jne</code>. </p>
<h2 id="Drop-Dex"><a href="#Drop-Dex" class="headerlink" title="Drop Dex"></a>Drop Dex</h2><p>If you look for dropped file in filesystem, you won’t see anything. File is removed with unlink. We can attach frida and catch dropped file easily. But forget about it and lets find how png file is used to create dex file. </p>
<p><img src="init.png" alt=""></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Yorumları görebilmek için lütfen JavaScripte izin verin.</noscript>
        </div>
    </div>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Ana Sayfa</a></li>
         
          <li><a href="/about/">Hakkımda</a></li>
         
          <li><a href="/archives/">Yazılar</a></li>
         
          <li><a href="/Search/">Ara</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Hydra"><span class="toc-number">1.</span> <span class="toc-text">Hydra</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Time-Check"><span class="toc-number">2.</span> <span class="toc-text">Time Check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GDB-Debug"><span class="toc-number">3.</span> <span class="toc-text">GDB Debug</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ghidra-Shenanigans"><span class="toc-number">4.</span> <span class="toc-text">Ghidra Shenanigans</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Drop-Dex"><span class="toc-number">5.</span> <span class="toc-text">Drop Dex</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&text=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&is_video=false&description=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Mobile Malware Analysis : Dissecting Hydra&body=Check out this article: http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&title=Mobile Malware Analysis : Dissecting Hydra"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://eybisi.run/Mobile-Malware-Analysis-Dissecting-Hydra/&name=Mobile Malware Analysis : Dissecting Hydra&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menü</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> İçindekiler</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Paylaş</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Başa dön</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    in locexum we trust &copy; 2019 Ahmet Bilal Can
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Ana Sayfa</a></li>
         
          <li><a href="/about/">Hakkımda</a></li>
         
          <li><a href="/archives/">Yazılar</a></li>
         
          <li><a href="/Search/">Ara</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-129796595-1', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'eybisi-run';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


